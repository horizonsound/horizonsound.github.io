{% comment %}
UNIFIED CAROUSEL COMPONENT
Supports:
- playlist pages (mode="playlist")
- song pages (mode="song")
- public_only=true/false
- current = currently active song object
- songs = list of song_ids OR list of song objects OR list of music.yml meta objects
{% endcomment %}

{% assign mode = include.mode | default: "playlist" %}
{% assign public_only = include.public_only | default: false %}
{% assign current = include.current %}
{% assign songs = include.songs %}

{% if site.debug %}
<div class="debug-block">
<pre style="background:#222; color:#0f0; padding:1rem; margin:1rem 0; white-space:pre-wrap;">
CAROUSEL DEBUG (TOP-LEVEL)
==============================

mode:
{{ mode }}

public_only:
{{ public_only }}

current (active song):
{{ current | jsonify }}

songs (raw input list):
{{ songs | jsonify }}

</pre>
</div>
{% endif %}

<div class="playlist-carousel">

  <!-- LEFT ARROW -->
  <button class="carousel-arrow left-arrow">‹</button>

  <!-- SCROLLING STRIP -->
  <div class="horizontal-strip">

    {% for item in songs %}

      {% if site.debug %}
      <div class="debug-block">
      <pre style="background:#333; color:#ff0; padding:0.5rem; margin:0.5rem 0; white-space:pre-wrap;">
NORMALIZING ITEM:
{{ item | jsonify }}
      </pre>
      </div>
      {% endif %}

      {%- comment -%}
      Normalize item → always produce:
      - song_id
      - url
      - song (site.songs page)
      - meta (music.yml entry)
      {%- endcomment -%}

      {% assign song = nil %}
      {% assign meta = nil %}
      {% assign url = nil %}
      {% assign song_id = nil %}

      {# CASE 1: item is a full song page object #}
      {% if item.song_id %}
        {% assign song = item %}
        {% assign song_id = item.song_id %}
        {% assign url = item.url %}
        {% assign meta = site.data.music.songs | where: "url", url | first %}

      {# CASE 2: item is a meta object from music.yml #}
      {% elsif item.url %}
        {% assign url = item.url %}
        {% assign meta = item %}
        {% assign song_id = url | split: "/" | last %}
        {% if song_id == "" %}
          {% assign song_id = url | split: "/" | slice: -2, 1 %}
        {% endif %}
        {% assign song = site.songs | where: "song_id", song_id | first %}

      {# CASE 3: item is a bare song_id string #}
      {% else %}
        {% assign song_id = item %}
        {% assign song = site.songs | where: "song_id", song_id | first %}
        {% if song %}
          {% assign url = song.url %}
          {% assign meta = site.data.music.songs | where: "url", url | first %}
        {% endif %}
      {% endif %}

      {% if site.debug %}
      <div class="debug-block">
      <pre style="background:#333; color:#0ff; padding:0.5rem; margin:0.5rem 0; white-space:pre-wrap;">
NORMALIZATION RESULT:
song_id: {{ song_id }}
url: {{ url }}
meta: {{ meta | jsonify }}
song: {{ song | jsonify }}
      </pre>
      </div>
      {% endif %}

      {# If normalization failed, skip #}
      {% if not song or not meta %}
        {% continue %}
      {% endif %}

      {# Public-only filtering #}
      {% if public_only and meta.videostatus != "Public" %}
        {% continue %}
      {% endif %}

      {# Determine active tile #}
      {% assign is_active = false %}
      {% if current and current.song_id == song_id %}
        {% assign is_active = true %}
      {% endif %}

      <div class="playlist-tile {% if is_active %}active-tile{% endif %}"
           data-song="{{ song_id }}"
           data-url="{{ url }}">
        <img src="{{ meta.image }}" alt="{{ song.title }}">
        <h3 class="tile-title">{{ song.title }}</h3>
      </div>

    {% endfor %}

  </div>

  <!-- RIGHT ARROW -->
  <button class="carousel-arrow right-arrow">›</button>

</div>
