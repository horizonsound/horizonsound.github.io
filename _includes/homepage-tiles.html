<section class="homepage-section">

  {%- comment -%}
    Build a sortable list of resolved items (songs or playlists)
  {%- endcomment -%}

  {% assign resolved = "" | split: "" %}

  {% for item in include.items %}

    {% if item.type == "song" %}
      {% assign s = site.data.music.songs | where: "song_id", item.id | first %}

      {% if s %}
        {% assign sort_date = s.published_at %}
        {% assign is_public = s.videostatus == "Public" %}
        {% assign is_scheduled = s.videostatus == "Scheduled" %}

        {% assign resolved = resolved | push: 
          item | merge: 
            type: "song",
            title: s.title,
            image: s.image,
            url: s.url,
            videostatus: s.videostatus,
            sort_date: sort_date,
            is_public: is_public,
            is_scheduled: is_scheduled
        %}
      {% endif %}

    {% elsif item.type == "playlist" %}
      {% assign pl = site.data.playlists | where: "playlist_id", item.id | first %}

      {% if pl %}
        {% assign has_public = false %}
        {% assign newest_public_date = nil %}
        {% assign soonest_scheduled_date = nil %}

        {% for sid in pl.songs %}
          {% assign s = site.data.music.songs | where: "song_id", sid | first %}
          {% if s %}
            {% if s.videostatus == "Public" %}
              {% assign has_public = true %}
              {% if newest_public_date == nil or s.published_at > newest_public_date %}
                {% assign newest_public_date = s.published_at %}
              {% endif %}
            {% elsif s.videostatus == "Scheduled" %}
              {% if soonest_scheduled_date == nil or s.published_at < soonest_scheduled_date %}
                {% assign soonest_scheduled_date = s.published_at %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if has_public %}
          {% assign sort_date = newest_public_date %}
        {% else %}
          {% assign sort_date = soonest_scheduled_date %}
        {% endif %}

        {% assign playlist_image = site.baseurl | append: "/assets/thumbnails/playlist-" | append: pl.playlist_id | append: ".jpeg" %}

        {% assign resolved = resolved | push:
          item | merge:
            type: "playlist",
            title: pl.title,
            playlist_id: pl.playlist_id,
            image: playlist_image,
            has_public: has_public,
            sort_date: sort_date
        %}
      {% endif %}
    {% endif %}

  {% endfor %}

  {%- comment -%}
    Sort all items by sort_date DESC for public,
    ASC for scheduled (handled by logic below)
  {%- endcomment -%}

  {% assign public_items = resolved | where: "has_public", true %}
  {% assign scheduled_items = resolved | where: "has_public", false %}

  {% assign public_items = public_items | sort: "sort_date" | reverse %}
  {% assign scheduled_items = scheduled_items | sort: "sort_date" %}

  {% assign sorted = public_items | concat: scheduled_items %}

  <div class="tile-grid">

    {% for item in sorted %}

      {% if item.type == "song" %}
        {% if item.videostatus == "Scheduled" %}
          <div class="tile coming-soon">
            <img src="{{ site.baseurl }}{{ item.image }}" alt="{{ item.title }}">
            <div class="tile-overlay">Coming Soon</div>
            <h3 class="tile-title">{{ item.title }}</h3>
          </div>
        {% else %}
          <a class="tile" href="{{ site.baseurl }}{{ item.url }}">
            <img src="{{ site.baseurl }}{{ item.image }}" alt="{{ item.title }}">
            <h3 class="tile-title">{{ item.title }}</h3>
          </a>
        {% endif %}
      {% endif %}

      {% if item.type == "playlist" %}
        {% if item.has_public %}
          <a class="tile" href="{{ site.baseurl }}/music/playlists/{{ item.playlist_id }}/">
            <img src="{{ item.image }}" alt="{{ item.title }}">
            <h3 class="tile-title">{{ item.title }}</h3>
          </a>
        {% else %}
          <div class="tile coming-soon">
            <img src="{{ item.image }}" alt="{{ item.title }}">
            <div class="tile-overlay">Coming Soon</div>
            <h3 class="tile-title">{{ item.title }}</h3>
          </div>
        {% endif %}
      {% endif %}

    {% endfor %}

  </div>

</section>
